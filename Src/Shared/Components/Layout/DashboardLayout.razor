@inherits LayoutComponentBase
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using ProjectDashboard.Shared.Data
@using ProjectDashboard.Shared.Models
@using ProjectDashboard.Shared.Services
@using Microsoft.AspNetCore.Components.Routing
@inject IDbContextFactory<AppDbContext> DbFactory
@inject AppStateService AppState
@inject IJSRuntime JS
@inject NavigationManager NavManager
@implements IDisposable

<div class="flex flex-col h-screen text-gray-300 font-sans antialiased" style="background-color: #1a1a1a; color: #a1a1aa;">
    <div class="flex flex-1 overflow-hidden">
        
        <aside class="@(isSidebarCollapsed ? "w-[52px]" : "w-[220px]") shrink-0 flex flex-col border-r border-[#2a2a2a] transition-all duration-300" style="background-color: #161616; overflow-x: hidden;">
            
            <div @onclick="ToggleSidebarFromJS" class="px-4 py-5 flex items-center justify-between text-[#d4d4d8] cursor-pointer hover:bg-white/5 transition-colors whitespace-nowrap">
                <div class="flex items-center gap-2">
                    <div class="flex gap-0.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-white opacity-90"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-white opacity-60"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-white opacity-30"></div>
                    </div>
                    @if (!isSidebarCollapsed)
                    {
                        <span class="text-sm font-medium transition-opacity">Projects Hub</span>
                        <svg class="w-3.5 h-3.5 opacity-50 ml-1 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    }
                </div>
                @if (!isSidebarCollapsed)
                {
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-panel-right-close shrink-0 w-4 h-4 opacity-40 hover:opacity-100 text-[#d4d4d8]"><rect width="18" height="18" x="3" y="3" rx="2"></rect><path d="M15 3v18"></path><path d="m8 9 3 3-3 3"></path></svg>
                }
            </div>

            <nav class="flex-1 px-3 py-2 space-y-6 overflow-y-auto custom-scrollbar text-[13px] font-medium">
                
                
                <div>
                    @if (!isSidebarCollapsed)
                    {
                        <h2 class="px-2 mb-2 text-[11px] text-[#6b6b70] whitespace-nowrap transition-opacity">General</h2>
                    }
                    <ul class="space-y-0.5">
                        <li>
                            <a href="/" class="flex items-center justify-between px-2 py-1.5 rounded-md transition-colors group @GetNavClass("/")" title="Dashboard">
                                <div class="flex items-center gap-2.5">
                                    <svg class="w-4 h-4 opacity-50 text-white group-hover:opacity-100 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                    @if (!isSidebarCollapsed) { <span class="whitespace-nowrap transition-opacity">Dashboard</span> }
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="/projects" class="flex items-center justify-between px-2 py-1.5 rounded-md transition-colors group @GetNavClass("/projects")" title="All Projects">
                                <div class="flex items-center gap-2.5">
                                    <svg class="w-4 h-4 opacity-50 group-hover:opacity-100 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                                    @if (!isSidebarCollapsed) { <span class="whitespace-nowrap transition-opacity">All Projects</span> }
                                </div>
                                @if (!isSidebarCollapsed) { <span class="text-[10px] text-[#6b6b70] shrink-0">@totalProjects</span> }
                            </a>
                        </li>
                        <li>
                            <a href="/activity" class="flex items-center justify-between px-2 py-1.5 rounded-md transition-colors group @GetNavClass("/activity")" title="Recent Activity">
                                <div class="flex items-center gap-2.5">
                                    <svg class="w-4 h-4 opacity-50 group-hover:opacity-100 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    @if (!isSidebarCollapsed) { <span class="whitespace-nowrap transition-opacity">Recent Activity</span> }
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>

                
                <div>
                    @if (!isSidebarCollapsed)
                    {
                        <div class="flex items-center justify-between px-2 mb-2 whitespace-nowrap transition-opacity">
                            <h2 class="text-[11px] text-[#6b6b70]">Favorites</h2>
                            <button class="opacity-40 hover:opacity-100 text-white"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                        </div>
                    }
                    @if (pinnedProjects.Any())
                    {
                        <ul class="space-y-0.5">
                            @foreach (var p in pinnedProjects)
                            {
                                <li>
                                    <a href="/project/@p.Id" class="flex items-center justify-between px-2 py-1.5 rounded-md transition-colors truncate @GetNavClass($"/project/{p.Id}")" title="@p.Name">
                                        <div class="flex items-center gap-2.5 truncate">
                                            <div class="w-4 h-4 rounded-full bg-linear-to-br from-indigo-500 to-purple-500 shrink-0 flex items-center justify-center text-[8px] text-white font-bold">@p.Name.Substring(0,1).ToUpper()</div>
                                            @if (!isSidebarCollapsed) { <span class="truncate transition-opacity">@p.Name</span> }
                                        </div>
                                        @if (!isSidebarCollapsed) { <span class="text-[10px] text-[#6b6b70] hidden group-hover:block shrink-0">Project</span> }
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                    else if (!isSidebarCollapsed)
                    {
                        <div class="px-2 text-xs text-[#5b5b60] italic whitespace-nowrap transition-opacity">No favorites yet</div>
                    }
                </div>

                
            </nav>

            <div class="px-3 py-3 border-t border-[#2a2a2a] shrink-0 mt-auto">
                <a href="/settings" class="flex items-center px-1 py-1.5 text-[13px] font-medium rounded-md transition-colors @(isSidebarCollapsed ? "justify-center" : "") @GetNavClass("/settings")" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cog w-4 h-4 @(isSidebarCollapsed ? "" : "mr-2.5") opacity-50 shrink-0"><path d="M11 10.27 7 3.34"></path><path d="m11 13.73-4 6.93"></path><path d="M12 22v-2"></path><path d="M12 2v2"></path><path d="M14 12h8"></path><path d="m17 20.66-1-1.73"></path><path d="m17 3.34-1 1.73"></path><path d="M2 12h2"></path><path d="m20.66 17-1.73-1"></path><path d="m20.66 7-1.73 1"></path><path d="m3.34 17 1.73-1"></path><path d="m3.34 7 1.73 1"></path><circle cx="12" cy="12" r="2"></circle><circle cx="12" cy="12" r="8"></circle></svg>
                    @if (!isSidebarCollapsed) { <span class="whitespace-nowrap transition-opacity">Settings</span> }
                </a>
            </div>
        </aside>

        
        <main class="flex-1 overflow-y-auto custom-scrollbar" style="background-color: #1a1a1a;">
            @Body
        </main>
    </div>
</div>

@code {
    private List<Project> pinnedProjects = new();
    private List<Project> recentProjects = new();
    private int activeThisWeek;
    private int stalledCount;
    private int totalProjects;
    private bool isSidebarCollapsed = false;
    private DotNetObjectReference<DashboardLayout>? objRef;
    private string currentUrl = "";

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        currentUrl = NavManager.ToBaseRelativePath(NavManager.Uri);
        NavManager.LocationChanged += OnLocationChanged;
        AppState.OnChange += StateHasChanged;
        await LoadData();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && objRef != null)
        {
            try
            {
                await JS.InvokeVoidAsync("eval", @"
                    window.registerSidebarHotkey = function(dotNetHelper) {
                        window.addEventListener('keydown', function(e) {
                            if (e.ctrlKey && e.key.toLowerCase() === 'b') {
                                e.preventDefault();
                                dotNetHelper.invokeMethodAsync('ToggleSidebarFromJS');
                            }
                        });
                    }
                ");
                await JS.InvokeVoidAsync("window.registerSidebarHotkey", objRef);
            }
            catch {}
        }
    }

    [JSInvokable]
    public void ToggleSidebarFromJS()
    {
        isSidebarCollapsed = !isSidebarCollapsed;
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        var allProjects = await db.Projects
            .OrderByDescending(p => p.LastCommit)
            .ToListAsync();

        totalProjects = allProjects.Count;
        pinnedProjects = allProjects.Where(p => p.IsPinned).ToList();
        recentProjects = allProjects.Take(10).ToList();

        var now = DateTime.UtcNow;
        activeThisWeek = allProjects.Count(p => p.LastCommit.HasValue && (now - p.LastCommit.Value).TotalDays <= 7);
        stalledCount = allProjects.Count(p => p.LastCommit.HasValue && (now - p.LastCommit.Value).TotalDays > 30);
    }

    private string GetNavClass(string href)
    {
        var target = href.TrimStart('/');
        if (string.IsNullOrEmpty(target))
        {
            return string.IsNullOrEmpty(currentUrl) ? "bg-white/10 text-white" : "text-[#8b8b90] hover:bg-white/5 hover:text-[#d4d4d8]";
        }
        return currentUrl.StartsWith(target, StringComparison.OrdinalIgnoreCase)
            ? "bg-white/10 text-white"
            : "text-[#8b8b90] hover:bg-white/5 hover:text-[#d4d4d8]";
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= OnLocationChanged;
        AppState.OnChange -= StateHasChanged;
        objRef?.Dispose();
    }
}

