@page "/project/{ProjectId:int}"

@layout ProjectDashboard.Shared.Components.Layout.DashboardLayout
@using Microsoft.EntityFrameworkCore
@using ProjectDashboard.Shared.Data
@using ProjectDashboard.Shared.Models
@using ProjectDashboard.Shared.Services
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject AppStateService AppState
@inject ScannerService Scanner
@using Microsoft.JSInterop
@inject IJSRuntime JS
@using System.Diagnostics

@if (project == null)
{
    <div class="flex items-center justify-center h-full min-h-screen text-[#d4d4d8] font-sans" style="background-color: #1a1a1a;">
        <p class="text-[#8b8b90] font-medium tracking-wide">Loading...</p>
    </div>
}
else
{
<div class="min-h-screen text-[#d4d4d8] p-6 lg:p-8 font-sans" style="background-color: #1a1a1a;">
    
    
    <div class="flex items-center justify-between mb-8 text-[13px]">
        <nav class="flex items-center gap-2 text-[#8b8b90]">
            <a href="/" class="hover:text-white transition-colors">Projects</a>
            <svg class="w-3.5 h-3.5 opacity-50 text-[#8b8b90]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
            <span class="text-[#d4d4d8]">@project.Name</span>
        </nav>

        <div class="flex items-center gap-2">
            <button @onclick="OpenTerminal" class="px-3 h-8 rounded-md bg-[#2a2a2a] border border-[#3a3a3a] flex items-center gap-2 hover:bg-[#3a3a3a] transition-colors">
                <svg class="w-4 h-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" />
                </svg>
                <span class="opacity-90">Terminal</span>
            </button>
            <button @onclick="OpenInEditor" class="px-4 h-8 rounded-md bg-[#0088ff] hover:bg-[#0077ee] text-white flex items-center gap-1.5 transition-colors shadow-[0_0_10px_rgba(0,136,255,0.3)] font-medium">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                </svg>
                <span>@editorName</span>
            </button>
        </div>
    </div>

    
    <div class="mb-6 border-b border-[#2a2a2a] pb-6">
        <div class="flex items-center gap-3 mb-2">
            <h1 class="text-2xl font-medium tracking-wide text-white">@project.Name</h1>
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] uppercase font-bold tracking-wide @GetStatusClasses(project.Status)">
                <span class="w-1.5 h-1.5 rounded-full mr-1.5" style="background-color: currentColor;"></span>
                @project.Status
            </span>
            @if (project.IsPinned)
            {
                <span class="w-2 h-2 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 shadow-[0_0_6px_rgba(99,102,241,0.5)]"></span>
            }
        </div>
        <div class="flex items-center gap-3 text-sm text-[#8b8b90] font-mono">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
            </svg>
            <span>@project.Path</span>
            <button @onclick="CopyPath" class="hover:text-white transition-colors opacity-70 hover:opacity-100" title="Copy to clipboard">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
                </svg>
            </button>
        </div>
    </div>

    
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 mb-12">

        
        <div class="lg:col-span-3 space-y-5">
            
            <div class="bg-[#1e1e20] border border-[#2a2a2a] rounded-xl p-5 hover:border-[#3a3a3a] transition-colors shadow-sm">
                <div class="flex items-center gap-2 mb-5 tracking-wide text-[11px] font-medium text-[#8b8b90] uppercase">
                    <svg class="w-3.5 h-3.5 text-[#00E5FF]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                    Inferred Tech Stack
                </div>
                
                <div class="flex flex-wrap gap-2">
                    @foreach (var pill in project.TechPills)
                    {
                        <span class="inline-flex items-center px-2 py-1 text-[11px] font-medium text-[#d4d4d8] bg-[#2a2a2a] border border-[#3a3a3a] rounded hover:bg-[#3a3a3a] transition-colors cursor-default">@pill</span>
                    }
                    @if (!project.TechPills.Any())
                    {
                        <span class="text-[11px] text-[#5b5b60] italic">No inferred stack</span>
                    }
                </div>
            </div>

            
            <div class="bg-[#1e1e20] border border-[#2a2a2a] rounded-xl p-5 hover:border-[#3a3a3a] transition-colors shadow-sm">
                <div class="flex items-center gap-2 mb-4 tracking-wide text-[11px] font-medium text-[#8b8b90] uppercase">
                    <svg class="w-3.5 h-3.5 text-[#00E5FF]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                    </svg>
                    Tags
                </div>
                <div class="flex flex-wrap gap-2">
                    @foreach (var tag in project.TagList)
                    {
                        <span class="inline-flex items-center px-2 py-1 text-[11px] font-medium text-[#d4d4d8] bg-[#2a2a2a] border border-[#3a3a3a] rounded hover:bg-[#3a3a3a] transition-colors cursor-default">@tag</span>
                    }
                    @if (!project.TagList.Any())
                    {
                        <span class="text-[11px] text-[#5b5b60] italic">No tags</span>
                    }
                </div>
                <div class="mt-4 text-[11px] font-medium text-[#0088ff] hover:text-[#00E5FF] transition-colors tracking-wide cursor-pointer flex items-center gap-1 w-fit group uppercase">
                    Manage Tags
                    <svg class="w-3 h-3 group-hover:translate-x-0.5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
            </div>
        </div>

        
        <div class="lg:col-span-5 space-y-5">
            <div class="bg-[#1e1e20] border border-[#2a2a2a] rounded-xl p-5 hover:border-[#3a3a3a] transition-colors shadow-sm min-h-full">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-2 tracking-wide text-[11px] font-medium text-[#8b8b90] uppercase">
                        <svg class="w-3.5 h-3.5 text-[#00E5FF]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        Recent Activity
                    </div>
                </div>

                <div class="space-y-0 relative before:absolute before:inset-0 before:ml-1.5 before:w-px before:bg-[#2a2a2a] before:h-[calc(100%-2rem)]">
                    @foreach (var commit in recentCommits.Take(5))
                    {
                        <div class="relative pl-6 py-4 border-b border-[#2a2a2a]/50 last:border-0 last:pb-0 group">
                            
                            <div class="absolute left-[-1px] top-[24px] w-3.5 h-3.5 rounded-full border-2 border-[#1e1e20] bg-[#0088ff] shadow-[0_0_8px_rgba(0,136,255,0.4)] z-10 group-hover:bg-[#00E5FF] group-hover:shadow-[0_0_12px_rgba(0,229,255,0.6)] transition-all"></div>
                            
                            <p class="text-[13px] font-medium text-[#d4d4d8] mb-2 leading-relaxed group-hover:text-white transition-colors">
                                @commit.Message
                            </p>
                            <div class="flex items-center gap-2.5 text-[11px] text-[#8b8b90] font-medium">
                                <span class="flex items-center justify-center w-5 h-5 rounded-full bg-[#2a2a2a] text-[9px] font-bold text-[#d4d4d8] uppercase">
                                  @(commit.Author.Length > 0 ? commit.Author[..1].ToUpper() : "?")
                                </span>
                                <span>@commit.Author</span>
                                <span class="w-1 h-1 rounded-full bg-[#3a3a3a]"></span>
                                <span>@FormatCommitDate(commit.Date)</span>
                            </div>
                        </div>
                    }
                    @if (!recentCommits.Any())
                    {
                        <div class="pl-6 py-4">
                            <p class="text-[12px] text-[#5b5b60] italic">No recent activity detected.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        
        <div class="lg:col-span-4 space-y-5">
            
            <div class="bg-[#1e1e20] border border-[#2a2a2a] rounded-xl p-5 hover:border-[#3a3a3a] transition-colors shadow-sm">
                 <div class="flex items-center gap-2 mb-6 tracking-wide text-[11px] font-medium text-[#8b8b90] uppercase">
                    <svg class="w-3.5 h-3.5 text-[#00E5FF]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                    </svg>
                    Project Health
                </div>

                <div class="mb-6 border-b border-[#2a2a2a]/50 pb-5">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-[11px] text-[#8b8b90] font-medium">Stall Risk</span>
                        @if (project.Status == "Active")
                        {
                            <span class="text-[11px] font-bold text-[#34c759]">Low</span>
                        }
                        else if (project.Status == "Recent")
                        {
                            <span class="text-[11px] font-bold text-[#0088ff]">Normal</span>
                        }
                        else if (project.Status == "Stalled")
                        {
                            <span class="text-[11px] font-bold text-[#ffcc00]">High</span>
                        }
                        else
                        {
                            <span class="text-[11px] font-bold text-[#5b5b60]">Archived</span>
                        }
                    </div>
                    
                    <div class="w-full h-1.5 bg-[#2a2a2a] rounded-full mb-2 overflow-hidden flex">
                    @if (project.Status == "Active") {
                        <div class="h-full bg-[#34c759] w-[15%] rounded-full shadow-[0_0_8px_rgba(52,199,89,0.5)]"></div>
                    } else if (project.Status == "Recent") {
                        <div class="h-full bg-[#0088ff] w-[50%] rounded-full shadow-[0_0_8px_rgba(0,136,255,0.5)]"></div>
                    } else if (project.Status == "Stalled") {
                        <div class="h-full bg-[#ffcc00] w-[85%] rounded-full shadow-[0_0_8px_rgba(255,204,0,0.5)]"></div>
                    } else {
                        <div class="h-full bg-[#5b5b60] w-[100%] rounded-full shadow-[0_0_8px_rgba(91,91,96,0.3)]"></div>
                    }
                    </div>
                    <p class="text-[10px] text-[#5b5b60]">Last commit @project.TimeAgo</p>
                </div>

                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-[#161618] border border-[#2a2a2a] rounded-xl p-4 flex flex-col items-start justify-center">
                        <span class="text-[11px] text-[#8b8b90] mb-1 font-medium">Total Files</span>
                        <span class="text-2xl font-medium text-white">@project.DocCount</span>
                    </div>
                    <div class="bg-[#161618] border border-[#2a2a2a] rounded-xl p-4 flex flex-col items-start justify-center">
                        <span class="text-[11px] text-[#8b8b90] mb-1 font-medium">Commits</span>
                        <span class="text-2xl font-medium text-white">@project.TotalCommits</span>
                    </div>
                </div>

                <div class="space-y-4 text-[12px]">
                    <div class="flex items-start justify-between">
                        <span class="text-[#8b8b90] font-medium">Last Scanned</span>
                        <span class="font-medium text-[#d4d4d8] text-right">@(project.ScannedAt?.ToString("MMM dd, HH:mm") ?? "Never")</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[#8b8b90] font-medium">Branch</span>
                        <span class="flex items-center gap-1.5 font-medium text-[#d4d4d8]">
                            <svg class="w-3.5 h-3.5 text-[#5b5b60]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 15h2.25m8.024-9.75c.011.05.028.1.052.148.591 1.2.924 2.55.924 3.977a8.96 8.96 0 01-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398C20.613 14.547 19.833 15 19 15h-1.053c-.472 0-.745-.556-.5-.96a8.95 8.95 0 00.303-.54m.023-8.25H16.48a4.5 4.5 0 01-1.423-.23l-3.114-1.04a4.5 4.5 0 00-1.423-.23H6.504c-.351 0-.674.244-.738.59-.064.346.12.684.453.842M5.25 15h13.5" />
                            </svg>
                            @(project.CurrentBranch ?? "main")
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[#8b8b90] font-medium">Contributors</span>
                        <div class="flex items-center -space-x-1.5">
                            @foreach (var name in contributorNames.Take(3))
                            {
                                <div class="w-5 h-5 rounded-full bg-[#0088ff] border border-[#1e1e20] flex items-center justify-center text-[8px] font-bold text-white z-20" title="@name">@(name.Length > 0 ? name[..1].ToUpper() : "?")</div>
                            }
                            @if (contributorNames.Count > 3)
                            {
                                <div class="w-5 h-5 rounded-full bg-[#2a2a2a] border border-[#1e1e20] flex items-center justify-center text-[8px] font-bold text-[#8b8b90]">+@(contributorNames.Count - 3)</div>
                            }
                            @if (!contributorNames.Any())
                            {
                                <span class="text-[11px] text-[#5b5b60] italic">None</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="bg-[#161618] border border-[#2a2a2a] rounded-xl p-5 hover:border-[#3a3a3a] transition-colors shadow-sm">
                <h3 class="text-[11px] font-medium tracking-wide text-[#8b8b90] mb-4 px-1 uppercase">Quick Actions</h3>
                <div class="space-y-2">
                    <button @onclick="RescanProject" disabled="@isRescanning" class="w-full flex items-center gap-3 px-3 py-2.5 text-[13px] font-medium text-[#d4d4d8] bg-[#2a2a2a]/50 rounded-lg hover:bg-[#3a3a3a] transition-colors disabled:opacity-50">
                        @if (isRescanning)
                        {
                            <svg class="w-4 h-4 animate-spin text-[#00E5FF]" viewBox="0 0 24 24" fill="none">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <span>Scanning...</span>
                        }
                        else
                        {
                            <svg class="w-4 h-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                            <span>Rescan Project</span>
                        }
                    </button>
                    <button @onclick="RotatePin" class="w-full flex items-center gap-3 px-3 py-2.5 text-[13px] font-medium text-[#d4d4d8] bg-[#2a2a2a]/50 rounded-lg hover:bg-[#3a3a3a] transition-colors">
                        <svg class="w-4 h-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                        </svg>
                        <span>@(project.IsPinned ? "Unpin Project" : "Pin Project")</span>
                    </button>
                    <button @onclick="NavigateSettings" class="w-full flex items-center gap-3 px-3 py-2.5 text-[13px] font-medium text-[#d4d4d8] bg-[#2a2a2a]/50 rounded-lg hover:bg-[#3a3a3a] transition-colors">
                        <svg class="w-4 h-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.34 15.84c-.4.07-.82.16-1.25.16-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7c0 .43-.09.85-.16 1.25M19.4 12c.3.56.5 1.18.57 1.84M22 22l-2-2M15.58 15.58l-1.06 1.06m0-4.24-1.42 1.42M12 10.5h.01" />
                        </svg>
                        <span>App Settings</span>
                    </button>
                    <button @onclick="() => showDeleteModal = true" class="w-full flex items-center gap-3 px-3 py-2.5 text-[13px] font-medium text-[#ff3b30] bg-[#ff3b30]/10 border border-[#ff3b30]/20 rounded-lg hover:bg-[#ff3b30]/20 transition-colors mt-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span>Delete Project</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@if (showDeleteModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
        
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @onclick="() => showDeleteModal = false"></div>

        
        <div class="relative bg-[#1e1e20] rounded-xl shadow-[0_0_30px_rgba(0,0,0,0.8)] w-full max-w-md border border-[#2a2a2a] overflow-hidden" @onclick:stopPropagation="true">
            <div class="px-6 py-6">
                <div class="flex items-center gap-3 mb-4 text-[#ff3b30]">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h2 class="text-lg font-medium tracking-wide">Delete Project</h2>
                </div>
                <p class="text-[13px] text-[#8b8b90] mb-5 leading-relaxed">
                    Are you sure you want to permanently delete <strong class="text-white">@project.Name</strong>? This will remove the tracking from Project Dashboard 
                    and <strong class="text-[#ff3b30]">completely delete the files from your hard drive (@project.Path)</strong>. This action cannot be undone.
                </p>
                @if (!string.IsNullOrEmpty(deleteError))
                {
                    <p class="text-[12px] text-[#ff3b30] bg-[#ff3b30]/10 border border-[#ff3b30]/20 px-3 py-2 rounded-lg mb-5">@deleteError</p>
                }
                <div class="flex gap-3 justify-end mt-2">
                    <button @onclick="() => showDeleteModal = false" class="px-4 py-2 text-[13px] font-medium text-[#d4d4d8] bg-[#2a2a2a] border border-[#3a3a3a] rounded-lg hover:bg-[#3a3a3a] transition-colors">Cancel</button>
                    <button @onclick="DeleteProjectAsync" disabled="@isDeleting" class="px-4 py-2 text-[13px] font-medium text-white bg-[#ff3b30] rounded-lg hover:bg-[#ff1a10] shadow-[0_0_12px_rgba(255,59,48,0.4)] disabled:opacity-50 transition-colors flex items-center gap-2">
                        @if (isDeleting)
                        {
                            <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <span>Yes, Delete Completely</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

}

@code {
    [Parameter] public int ProjectId { get; set; }

    private Project? project;
    private List<CommitInfo> recentCommits = new();
    private List<string> contributorNames = new();
    private List<string> docFiles = new();
    private List<string> branchNames = new();
    private List<GoalItem> goalItems = new();
    private string notesText = "";
    private string newTag = "";
    private string newGoalText = "";
    private bool showDeleteModal;
    private bool isDeleting;
    private bool isRescanning;
    private string deleteError = "";
    private string editorName = "Cursor";
    private string editorCommand = "cursor .";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                var storedEditor = await JS.InvokeAsync<string>("localStorage.getItem", "openInEditor");
                if (!string.IsNullOrEmpty(storedEditor))
                {
                    editorName = storedEditor;
                    editorCommand = storedEditor switch {
                        "VS Code" => "code .",
                        "Rider" => "rider64 .",
                        "Zed" => "zed .",
                        "Antigravity" => "antigravity .",
                        _ => "cursor ."
                    };
                    StateHasChanged();
                }
            }
            catch {}
        }
    }

    private async Task LoadData()
    {
        project = null; 
        using var db = await DbFactory.CreateDbContextAsync();
        project = await db.Projects.FindAsync(ProjectId);
        if (project == null) return;

        notesText = project.Notes ?? "";
        goalItems = project.GoalItems ?? new();
        showDeleteModal = false;

        
        var meta = project.Metadata;

        
        if (meta.TryGetValue("recent_commits", out var rc) && !string.IsNullOrWhiteSpace(rc))
        {
            recentCommits = rc.Split(";;", StringSplitOptions.RemoveEmptyEntries)
                .Select(entry =>
                {
                    var parts = entry.Split('|', 3);
                    return new CommitInfo
                    {
                        Date = parts.Length > 0 && DateTime.TryParse(parts[0], out var d) ? d : DateTime.MinValue,
                        Author = parts.Length > 1 ? parts[1] : "unknown",
                        Message = parts.Length > 2 ? parts[2] : ""
                    };
                })
                .Where(c => c.Date != DateTime.MinValue)
                .ToList();
        }
        else
        {
            recentCommits.Clear();
        }

        
        if (meta.TryGetValue("contributor_names", out var cn) && !string.IsNullOrWhiteSpace(cn))
            contributorNames = cn.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        else
            contributorNames.Clear();

        
        if (meta.TryGetValue("doc_files", out var df) && !string.IsNullOrWhiteSpace(df))
            docFiles = df.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        else
            docFiles.Clear();

        
        if (meta.TryGetValue("branches", out var br) && !string.IsNullOrWhiteSpace(br))
            branchNames = br.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        else
            branchNames.Clear();
            
        StateHasChanged();
    }

    
    private async Task AddTag()
    {
        if (string.IsNullOrWhiteSpace(newTag) || project == null) return;
        var tags = new List<string>(project.TagList);
        if (!tags.Contains(newTag.Trim(), StringComparer.OrdinalIgnoreCase))
        {
            tags.Add(newTag.Trim());
            project.Tags = string.Join(",", tags);
            await SaveProject();
        }
        newTag = "";
    }

    private async Task RemoveTag(string tag)
    {
        if (project == null) return;
        var tags = new List<string>(project.TagList);
        tags.Remove(tag);
        project.Tags = string.Join(",", tags);
        await SaveProject();
    }

    private async Task HandleTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await AddTag();
    }

    
    private async Task SaveNotes()
    {
        if (project == null) return;
        project.Notes = notesText;
        await SaveProject();
        StateHasChanged();
    }

    
    private async Task AddGoal()
    {
        if (string.IsNullOrWhiteSpace(newGoalText) || project == null) return;
        goalItems.Add(new GoalItem { Text = newGoalText.Trim(), Done = false });
        project.GoalItems = goalItems;
        await SaveProject();
        newGoalText = "";
    }

    private async Task ToggleGoal(int index, bool done)
    {
        if (project == null || index >= goalItems.Count) return;
        goalItems[index].Done = done;
        project.GoalItems = goalItems;
        await SaveProject();
    }

    private async Task RemoveGoal(int index)
    {
        if (project == null || index >= goalItems.Count) return;
        goalItems.RemoveAt(index);
        project.GoalItems = goalItems;
        await SaveProject();
    }

    private async Task HandleGoalKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await AddGoal();
    }

    
    private async Task TogglePin()
    {
        if (project == null) return;
        project.IsPinned = !project.IsPinned;
        await SaveProject();
        AppState.NotifyStateChanged();
    }
    
    private async Task RotatePin()
    {
        await TogglePin();
    }

    
    private async Task DeleteProjectAsync()
    {
        if (project == null) return;
        isDeleting = true;
        deleteError = "";
        StateHasChanged();
        await Task.Delay(1);

        try
        {
            if (Directory.Exists(project.Path))
            {
                ForceDeleteDirectory(project.Path);
            }

            using var db = await DbFactory.CreateDbContextAsync();
            db.Projects.Remove(project);
            await db.SaveChangesAsync();

            AppState.NotifyStateChanged();
            Nav.NavigateTo("/");
        }
        catch (Exception ex)
        {
            deleteError = $"Error deleting files: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    
    private async Task SaveProject()
    {
        if (project == null) return;
        using var db = await DbFactory.CreateDbContextAsync();
        db.Projects.Update(project);
        await db.SaveChangesAsync();
    }

    private void ForceDeleteDirectory(string targetDir)
    {
        var files = Directory.GetFiles(targetDir);
        var dirs = Directory.GetDirectories(targetDir);

        foreach (string file in files)
        {
            File.SetAttributes(file, FileAttributes.Normal);
            File.Delete(file);
        }

        foreach (string dir in dirs)
        {
            ForceDeleteDirectory(dir);
        }

        File.SetAttributes(targetDir, FileAttributes.Normal);
        Directory.Delete(targetDir, false);
    }

    private string GetMeta(string key)
    {
        return project?.Metadata.TryGetValue(key, out var v) == true ? v : "";
    }

    private string FormatCommitDate(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalDays < 1) return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays}d ago";
        return date.ToString("MMM dd, yyyy");
    }

    private string GetStatusClasses(string status) => status switch
    {
        "Active" => "text-[#34c759] bg-[#34c759]/10",
        "Recent" => "text-[#0088ff] bg-[#0088ff]/10",
        "Stalled" => "text-[#ffcc00] bg-[#ffcc00]/10",
        "Archived" => "text-[#8b8b90] bg-[#8b8b90]/10",
        _ => "text-[#8b8b90] bg-[#8b8b90]/10"
    };

    private record CommitInfo
    {
        public DateTime Date { get; init; }
        public string Author { get; init; } = "";
        public string Message { get; init; } = "";
    }

    

    private async Task CopyPath()
    {
        if (project == null) return;
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", project.Path);
    }

    private void OpenTerminal()
    {
        if (project == null || !Directory.Exists(project.Path)) return;
        try
        {
            Process.Start(new ProcessStartInfo { FileName = "cmd.exe", Arguments = $"/c start \"\" /d \"{project.Path}\" cmd", UseShellExecute = true });
        } catch {}
    }

    private void OpenInEditor()
    {
        if (project == null || !Directory.Exists(project.Path)) return;
        try
        {
            Process.Start(new ProcessStartInfo { FileName = "cmd.exe", Arguments = $"/c {editorCommand}", WorkingDirectory = project.Path, UseShellExecute = true, CreateNoWindow = true });
        } catch {}
    }

    private async Task RescanProject()
    {
        if (project == null) return;
        isRescanning = true;
        StateHasChanged();
        
        await Scanner.ScanAsync(project.Path, 9999); 
        await LoadData();
        
        isRescanning = false;
        StateHasChanged();
    }

    private void NavigateSettings()
    {
        Nav.NavigateTo("/settings");
    }

}
