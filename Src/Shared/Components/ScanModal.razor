@using Microsoft.EntityFrameworkCore
@using ProjectDashboard.Shared.Data
@using ProjectDashboard.Shared.Models
@using ProjectDashboard.Shared.Services
@inject IDbContextFactory<AppDbContext> DbFactory
@inject ScannerService Scanner
@inject IConfiguration Config
@inject IFolderPickerService FolderPicker

@if (IsVisible)
{
    
    <div class="fixed inset-0 z-40 bg-black/40 backdrop-blur-sm transition-opacity" @onclick="Close"></div>

    
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-card dark:bg-card rounded-2xl shadow-2xl w-full max-w-lg border border-border  overflow-hidden" @onclick:stopPropagation="true">
            
            
            <div class="px-6 py-5 border-b border-border">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg bg-blue-50 flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-base font-semibold text-card-foreground ">Scan Folders</h2>
                            <p class="text-xs text-muted-foreground dark:text-muted-foreground dark:text-muted-foreground">Choose which folders to scan for git repositories</p>
                        </div>
                    </div>
                    <button @onclick="Close" class="p-1.5 rounded-lg text-muted-foreground dark:text-muted-foreground hover:text-muted-foreground  hover:bg-muted  transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            
            <div class="px-6 py-5">
                
                <div class="flex gap-2 mb-5">
                    <div class="relative flex-1">
                        <svg class="absolute left-3 top-2.5 w-4 h-4 text-muted-foreground dark:text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                        </svg>
                        <input type="text" @bind="newFolderPath" @bind:event="oninput"
                               @onkeydown="HandleKeyDown"
                               placeholder="Enter folder path, e.g. D:\projects"
                               class="w-full py-2 pl-9 pr-3 text-sm border border-border  rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-shadow text-foreground  bg-card dark:bg-card placeholder:text-muted-foreground dark:text-muted-foreground" />
                    </div>
                    @if (FolderPicker.IsSupported)
                    {
                        <button @onclick="BrowseFolder"
                                class="px-3 py-2 text-sm font-medium text-foreground  bg-card dark:bg-card border border-border  rounded-lg hover:bg-muted/50  transition-colors shrink-0 flex items-center gap-1.5 focus:ring-2 focus:ring-blue-500/20">
                            <svg class="w-4 h-4 text-muted-foreground dark:text-muted-foreground dark:text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
                            </svg>
                            Browse
                        </button>
                    }
                    <button @onclick="AddFolder" disabled="@(string.IsNullOrWhiteSpace(newFolderPath))"
                            class="px-3.5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed transition-colors shrink-0 flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="mb-4 px-3 py-2 text-xs font-medium text-red-700 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2">
                        <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                        </svg>
                        @errorMessage
                    </div>
                }

                
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    @if (!folders.Any())
                    {
                        <div class="py-8 text-center">
                            <svg class="w-10 h-10 text-slate-200 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                            </svg>
                            <p class="text-sm text-muted-foreground dark:text-muted-foreground dark:text-muted-foreground">No folders added yet</p>
                            <p class="text-xs text-muted-foreground dark:text-muted-foreground mt-1">Add a folder path above to get started</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var folder in folders)
                        {
                            <div class="flex items-center justify-between px-3 py-2.5 bg-muted/50  border border-border  rounded-lg group hover:border-border  transition-colors">
                                <div class="flex items-center gap-2.5 min-w-0 flex-1">
                                    <svg class="w-4 h-4 text-amber-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                                    </svg>
                                    <span class="text-sm text-foreground  font-mono truncate">@folder.Path</span>
                                </div>
                                <button @onclick="() => RemoveFolder(folder)" 
                                        class="p-1 rounded text-muted-foreground dark:text-muted-foreground hover:text-red-600 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                    </svg>
                                </button>
                            </div>
                        }
                    }
                </div>

                
                @if (isScanning)
                {
                    <div class="mt-5 px-3 py-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-blue-600 animate-spin" viewBox="0 0 24 24" fill="none">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <div>
                                <p class="text-sm font-medium text-blue-800">Scanning folders...</p>
                                <p class="text-xs text-blue-600 mt-0.5">@scanProgressMessage</p>
                            </div>
                        </div>
                    </div>
                }
            </div>

            
            <div class="px-6 py-4 bg-muted/50  border-t border-border flex items-center justify-between">
                <p class="text-xs text-muted-foreground dark:text-muted-foreground dark:text-muted-foreground">
                    @folders.Count folder@(folders.Count == 1 ? "" : "s") configured
                </p>
                <div class="flex items-center gap-2">
                    <button @onclick="Close"
                            class="px-4 py-2 text-sm font-medium text-foreground  bg-card dark:bg-card border border-border  rounded-lg hover:bg-muted/50  transition-colors">
                        Cancel
                    </button>
                    <button @onclick="StartScan" disabled="@(!folders.Any() || isScanning)"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
                        @if (isScanning)
                        {
                            <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <span>Scanning...</span>
                        }
                        else
                        {
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                            <span>Start Scan</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnScanComplete { get; set; }

    private List<ScanFolder> folders = new();
    private string newFolderPath = "";
    private string errorMessage = "";
    private bool isScanning;
    private string scanProgressMessage = "";

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            await LoadFolders();
            errorMessage = "";
        }
    }

    private async Task LoadFolders()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        folders = await db.ScanFolders.OrderBy(f => f.CreatedAt).ToListAsync();
    }

    private async Task AddFolder()
    {
        errorMessage = "";
        var path = newFolderPath.Trim();

        if (string.IsNullOrWhiteSpace(path))
            return;

        
        if (!Directory.Exists(path))
        {
            errorMessage = $"Folder does not exist: {path}";
            return;
        }

        
        if (folders.Any(f => f.Path.Equals(path, StringComparison.OrdinalIgnoreCase)))
        {
            errorMessage = "This folder is already in the list.";
            return;
        }

        using var db = await DbFactory.CreateDbContextAsync();
        var folder = new ScanFolder { Path = path };
        db.ScanFolders.Add(folder);
        await db.SaveChangesAsync();

        newFolderPath = "";
        await LoadFolders();
    }

    private async Task RemoveFolder(ScanFolder folder)
    {
        using var db = await DbFactory.CreateDbContextAsync();
        var entity = await db.ScanFolders.FindAsync(folder.Id);
        if (entity != null)
        {
            db.ScanFolders.Remove(entity);
            await db.SaveChangesAsync();
        }
        await LoadFolders();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddFolder();
        }
    }

    private async Task BrowseFolder()
    {
        errorMessage = "";
        try
        {
            var path = await FolderPicker.PickFolderAsync();
            if (!string.IsNullOrEmpty(path))
            {
                newFolderPath = path;
                await AddFolder();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to pick folder: {ex.Message}";
        }
    }

    private async Task StartScan()
    {
        if (!folders.Any() || isScanning) return;

        isScanning = true;
        errorMessage = "";
        StateHasChanged();

        try
        {
            for (int i = 0; i < folders.Count; i++)
            {
                var folder = folders[i];
                scanProgressMessage = $"Scanning {folder.Path} ({i + 1}/{folders.Count})...";
                StateHasChanged();
                await Task.Delay(1); 

                await Scanner.ScanAsync(folder.Path, int.MaxValue);
            }

            scanProgressMessage = "Scan complete!";
            StateHasChanged();
            await Task.Delay(500);

            await OnScanComplete.InvokeAsync();
            await Close();
        }
        catch (Exception ex)
        {
            errorMessage = $"Scan failed: {ex.Message}";
        }
        finally
        {
            isScanning = false;
            StateHasChanged();
        }
    }

    private async Task Close()
    {
        if (!isScanning)
        {
            await OnClose.InvokeAsync();
        }
    }
}


